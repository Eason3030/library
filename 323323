/*
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 *        æ™ºæ…§è¼”åŠ©è¼ªç³»çµ± - äº¤ä»¶ç©©å®šç‰ˆ v1.2 âœ…
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * 
 * ã€v1.2 ä¿®æ­£é‡é»ã€‘
 * âœ… é€Ÿåº¦å…¬å¼æ”¹å› *3600.0ï¼ˆé€™æ˜¯æ­£ç¢ºçš„ï¼ï¼‰
 * âœ… executeCommand() é™ä½ä¿è­·æ”¹æˆã€Œä¸å‹•ä½œã€è€Œéã€Œå¼·åˆ¶ä¸‹é™ã€
 * âœ… ç§»é™¤å®¹æ˜“æ··æ·†çš„ stopMotor() å‘¼å«
 * 
 * ã€ç¡¬é«”æ©Ÿæ§‹èªªæ˜ã€‘
 * - ç¹¼é›»å™¨ ON  = è‡´å‹•å™¨ä¼¸å‡º = è¼”åŠ©è¼ªä¸Šå‡
 * - ç¹¼é›»å™¨ OFF = è‡´å‹•å™¨æ”¶å› = è¼”åŠ©è¼ªä¸‹é™
 * âš ï¸ æ³¨æ„ï¼šOFF ä¸æ˜¯ã€Œåœæ­¢ã€ï¼Œæ˜¯ã€Œä¸»å‹•ä¸‹é™ã€ï¼
 * 
 * ã€æ§åˆ¶é‚è¼¯ã€‘
 * 1. IR é™æ§ï¼šä»»æ„éµå¾ªç’°ï¼ˆä¸Šå‡â†’ä¸‹é™â†’è‡ªå‹•ï¼‰
 * 2. è‡ªå‹•æ¨¡å¼ï¼šé€Ÿåº¦ > 15km/h ä¸Šå‡ï¼Œâ‰¤ 15km/h ä¸‹é™
 * 3. é™ä½ä¿è­·ï¼šåˆ°ä¸Šé™ç¦æ­¢ä¸Šå‡ï¼Œåˆ°ä¸‹é™ç¦æ­¢ä¸‹é™
 * 
 * ä½œè€…ï¼šæ—æ©åœ˜éšŠ
 * æ—¥æœŸï¼š2026/01/23
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 */

#include <Wire.h>
#include <IRremote.hpp>
#include <U8g2lib.h>

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“ åƒæ•¸è¨­å®šå€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const float SPEED_THRESHOLD = 15.0;           // é€Ÿåº¦é–€æª»ï¼ˆkm/hï¼‰
const float WHEEL_CIRCUMFERENCE = 2042.0;     // è¼ªèƒå‘¨é•·ï¼ˆmmï¼‰
const unsigned long HOMING_TIMEOUT = 20000;   // æ­¸é›¶è¶…æ™‚ï¼ˆ20ç§’ï¼‰
const unsigned long MOTOR_CHANGE_DELAY = 1000;// é¦¬é”å‹•ä½œé–“éš”ï¼ˆ1ç§’ï¼‰
const unsigned long IR_DEBOUNCE = 300;        // IR æŒ‰éµé˜²æŠ–ï¼ˆ300msï¼‰
const float SPEED_SMOOTH_ALPHA = 0.3;         // é€Ÿåº¦å¹³æ»‘ä¿‚æ•¸

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”Œ ç¡¬é«”æ¥è…³å®šç¾©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const uint8_t RELAY_PIN = 22;
const uint8_t LIMIT_UP_PIN = 13;
const uint8_t LIMIT_DOWN_PIN = 53;
const uint8_t HALL_SPEED_PIN = 2;
const uint8_t IR_RECEIVE_PIN = 3;
const uint8_t RGB_RED_PIN = 5;
const uint8_t RGB_GREEN_PIN = 6;
const uint8_t RGB_BLUE_PIN = 7;
const uint8_t BUZZER_PIN = 8;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ§© è³‡æ–™çµæ§‹å®šç¾©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

enum Priority {
    P_MANUAL = 0,
    P_SPEED = 1,
    P_IDLE = 2
};

enum IRMode {
    IR_MODE_UP = 0,
    IR_MODE_DOWN = 1,
    IR_MODE_STOP = 2
};

struct Command {
    Priority priority;
    bool wantUp;
    String reason;
    
    Command(Priority p, bool u, String r) 
        : priority(p), wantUp(u), reason(r) {}
    
    Command() : priority(P_IDLE), wantUp(false), reason("å¾…æ©Ÿ") {}
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸŒ å…¨åŸŸè®Šæ•¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

U8G2_SSD1306_128X64_NONAME_F_HW_I2C u8g2(U8G2_R0, U8X8_PIN_NONE);

volatile unsigned long lastSpeedTrigger = 0;
volatile unsigned long speedInterval = 0;
float currentSpeed = 0;
float smoothSpeed = 0;

Command activeCommand;

bool motorOn = false;
unsigned long lastMotorChange = 0;

IRMode currentIRMode = IR_MODE_STOP;
unsigned long lastIRTime = 0;

bool systemReady = false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âš¡ ä¸­æ–·å‡½å¼ï¼šé€Ÿåº¦æ¸¬é‡
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

void speedInterrupt() {
    unsigned long now = micros();
    speedInterval = now - lastSpeedTrigger;
    lastSpeedTrigger = now;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“Š è¨ˆç®—é€Ÿåº¦
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âœ… ä¿®æ­£é»ï¼šæ”¹å› *3600.0ï¼ˆé€™æ‰æ˜¯æ­£ç¢ºçš„ï¼ï¼‰

float calculateSpeed() {
    // 2 ç§’æ²’è§¸ç™¼ = éœæ­¢
    if (micros() - lastSpeedTrigger > 2000000) {
        smoothSpeed = 0;
        return 0.0;
    }
    
    if (speedInterval == 0) {
        return 0.0;
    }
    
    // âœ…âœ…âœ… æ­£ç¢ºå…¬å¼ï¼š*3600.0ï¼ˆä¸æ˜¯ 3.6ï¼‰âœ…âœ…âœ…
    // é€Ÿåº¦ (km/h) = (å‘¨é•· mm / æ™‚é–“ Î¼s) Ã— 3600
    // 
    // ç‚ºä»€éº¼æ˜¯ 3600ï¼Ÿ
    // 1. å‘¨é•·å–®ä½ï¼šmm
    // 2. æ™‚é–“å–®ä½ï¼šÎ¼sï¼ˆå¾®ç§’ï¼‰
    // 3. è¦è½‰æˆ km/hï¼š
    //    - 1 km = 1,000,000 mm
    //    - 1 h  = 3,600,000,000 Î¼s
    //    - (mm/Î¼s) Ã— (3,600,000,000/1,000,000) = (mm/Î¼s) Ã— 3600
    
    float rawSpeed = (WHEEL_CIRCUMFERENCE / speedInterval) * 3600.0;
    
    // é™åˆ¶åˆç†ç¯„åœ
    if (rawSpeed > 80.0 || rawSpeed < 0) {
        rawSpeed = 0;
    }
    
    // å¹³æ»‘è™•ç†
    smoothSpeed = SPEED_SMOOTH_ALPHA * rawSpeed + (1 - SPEED_SMOOTH_ALPHA) * smoothSpeed;
    
    return smoothSpeed;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ® æª¢æŸ¥ IR é™æ§
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Command checkManual() {
    if (IrReceiver.decode()) {
        uint32_t code = IrReceiver.decodedIRData.decodedRawData;
        
        if (millis() - lastIRTime > IR_DEBOUNCE) {
            if (code != 0xFFFFFFFF && code != 0) {
                currentIRMode = (IRMode)((currentIRMode + 1) % 3);
                
                switch (currentIRMode) {
                    case IR_MODE_UP:
                        Serial.println("ğŸ”µ IR: åˆ‡æ›åˆ°ã€ä¸Šå‡ã€‘æ¨¡å¼");
                        beep(1500, 100);
                        setRGB(0, 0, 255);
                        break;
                        
                    case IR_MODE_DOWN:
                        Serial.println("ğŸŸ¡ IR: åˆ‡æ›åˆ°ã€ä¸‹é™ã€‘æ¨¡å¼");
                        beep(1000, 100);
                        setRGB(255, 255, 0);
                        break;
                        
                    case IR_MODE_STOP:
                        Serial.println("ğŸŸ¢ IR: åˆ‡æ›åˆ°ã€è‡ªå‹•ã€‘æ¨¡å¼");
                        beep(500, 200);
                        setRGB(0, 255, 0);
                        break;
                }
                
                lastIRTime = millis();
            }
        }
        
        IrReceiver.resume();
    }
    
    switch (currentIRMode) {
        case IR_MODE_UP:
            return Command(P_MANUAL, true, "IRæ‰‹å‹•-ä¸Šå‡");
            
        case IR_MODE_DOWN:
            return Command(P_MANUAL, false, "IRæ‰‹å‹•-ä¸‹é™");
            
        case IR_MODE_STOP:
        default:
            return Command();
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸƒ æª¢æŸ¥é€Ÿåº¦
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Command checkSpeed() {
    if (currentSpeed > SPEED_THRESHOLD) {
        return Command(P_SPEED, true, "é€Ÿåº¦å¿«-ä¸Šå‡");
    } else {
        return Command(P_SPEED, false, "é€Ÿåº¦æ…¢-ä¸‹é™");
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¨ RGB LED æ§åˆ¶
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

void setRGB(uint8_t r, uint8_t g, uint8_t b) {
    analogWrite(RGB_RED_PIN, r);
    analogWrite(RGB_GREEN_PIN, g);
    analogWrite(RGB_BLUE_PIN, b);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”Š èœ‚é³´å™¨æ§åˆ¶
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

void beep(int freq, int duration) {
    tone(BUZZER_PIN, freq, duration);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ–¥ï¸ OLED é¡¯ç¤ºæ›´æ–°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

void updateDisplay() {
    u8g2.clearBuffer();
    
    u8g2.setFont(u8g2_font_ncenB08_tr);
    u8g2.drawStr(0, 10, "Training Wheel v1.2");
    
    u8g2.setFont(u8g2_font_6x10_tr);
    String modeStr = "IR: ";
    switch (currentIRMode) {
        case IR_MODE_UP:   modeStr += "UP"; break;
        case IR_MODE_DOWN: modeStr += "DOWN"; break;
        case IR_MODE_STOP: modeStr += "AUTO"; break;
    }
    u8g2.drawStr(0, 25, modeStr.c_str());
    
    u8g2.drawStr(0, 38, activeCommand.reason.c_str());
    
    String speedStr = "Spd:" + String(currentSpeed, 1) + " km/h";
    u8g2.drawStr(0, 51, speedStr.c_str());
    
    bool atTop = (digitalRead(LIMIT_UP_PIN) == LOW);
    bool atBottom = (digitalRead(LIMIT_DOWN_PIN) == LOW);
    
    String statusStr = "";
    if (atTop) statusStr += "TOP ";
    if (atBottom) statusStr += "BTM ";
    if (!atTop && !atBottom) statusStr += "MID ";
    statusStr += motorOn ? "[ON]" : "[OFF]";
    
    u8g2.drawStr(0, 64, statusStr.c_str());
    
    u8g2.sendBuffer();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸš— é¦¬é”æ§åˆ¶
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

void setMotor(bool on) {
    if (on == motorOn) {
        return;
    }
    
    if (millis() - lastMotorChange < MOTOR_CHANGE_DELAY) {
        return;
    }
    
    motorOn = on;
    lastMotorChange = millis();
    digitalWrite(RELAY_PIN, on ? HIGH : LOW);
    
    // RGB æŒ‡ç¤ºï¼ˆåªåœ¨è‡ªå‹•æ¨¡å¼ï¼‰
    if (currentIRMode == IR_MODE_STOP) {
        if (on) {
            setRGB(0, 0, 255);  // è—è‰² = ä¸Šå‡
        } else {
            setRGB(255, 255, 0);  // é»ƒè‰² = ä¸‹é™
        }
    }
    
    Serial.print("ğŸ”§ é¦¬é”: ");
    Serial.println(on ? "ON (ä¸Šå‡)" : "OFF (ä¸‹é™)");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¯ åŸ·è¡ŒæŒ‡ä»¤ï¼ˆæ ¸å¿ƒé‚è¼¯ï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âœ… ä¿®æ­£é»ï¼šé™ä½æ™‚ä¸å‘¼å«ä»»ä½•é¦¬é”å‡½å¼ï¼Œåªæ˜¯ã€Œä¸å‹•ä½œã€

void executeCommand(Command cmd) {
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // æ­¥é©Ÿ 1ï¼šè®€å–é™ä½é–‹é—œ
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    bool atTop = (digitalRead(LIMIT_UP_PIN) == LOW);
    bool atBottom = (digitalRead(LIMIT_DOWN_PIN) == LOW);
    
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // æ­¥é©Ÿ 2ï¼šé™ä½ä¿è­·ï¼ˆç›´æ¥ returnï¼Œä¸å‹•ä½œï¼‰
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    // âœ… åœ¨ä¸Šé™ä¸”æƒ³ä¸Šå‡ â†’ ä»€éº¼éƒ½ä¸åšï¼ˆä¿æŒç¾ç‹€ï¼‰
    if (atTop && cmd.wantUp) {
        Serial.println("âš ï¸ å·²åœ¨ä¸Šé™ï¼Œç¦æ­¢ä¸Šå‡");
        return;  // âœ… ä¸å‘¼å«ä»»ä½•é¦¬é”å‡½å¼
    }
    
    // âœ… åœ¨ä¸‹é™ä¸”æƒ³ä¸‹é™ â†’ ä»€éº¼éƒ½ä¸åšï¼ˆä¿æŒç¾ç‹€ï¼‰
    if (atBottom && !cmd.wantUp) {
        Serial.println("âš ï¸ å·²åœ¨ä¸‹é™ï¼Œç¦æ­¢ä¸‹é™");
        return;  // âœ… ä¸å‘¼å«ä»»ä½•é¦¬é”å‡½å¼
    }
    
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // æ­¥é©Ÿ 3ï¼šè™•ç†é–’ç½®ï¼ˆä¹Ÿæ˜¯ä¸å‹•ä½œï¼‰
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    // âœ… é–’ç½®ç‹€æ…‹ â†’ ä»€éº¼éƒ½ä¸åš
    if (cmd.priority == P_IDLE) {
        return;  // âœ… ä¸å‘¼å«ä»»ä½•é¦¬é”å‡½å¼
    }
    
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // æ­¥é©Ÿ 4ï¼šæ­£å¸¸åŸ·è¡Œï¼ˆåªæœ‰é€™è£¡æœƒå‹•é¦¬é”ï¼‰
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    if (cmd.wantUp) {
        setMotor(true);   // ç¹¼é›»å™¨ ON = ä¸Šå‡
    } else {
        setMotor(false);  // ç¹¼é›»å™¨ OFF = ä¸‹é™
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ è‡ªå‹•æ­¸é›¶
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

void autoHoming() {
    Serial.println("\n========== ğŸ é–‹å§‹æ­¸é›¶ ==========");
    
    u8g2.clearBuffer();
    u8g2.setFont(u8g2_font_ncenB08_tr);
    u8g2.drawStr(0, 25, "Homing...");
    u8g2.setFont(u8g2_font_6x10_tr);
    u8g2.drawStr(0, 40, "Waiting down limit");
    u8g2.sendBuffer();
    
    digitalWrite(RELAY_PIN, LOW);
    motorOn = false;
    
    unsigned long startTime = millis();
    bool ledState = false;
    
    while (digitalRead(LIMIT_DOWN_PIN) == HIGH) {
        if (millis() - startTime > HOMING_TIMEOUT) {
            Serial.println("âŒ æ­¸é›¶è¶…æ™‚ï¼");
            u8g2.clearBuffer();
            u8g2.setFont(u8g2_font_ncenB08_tr);
            u8g2.drawStr(0, 30, "ERROR:");
            u8g2.drawStr(0, 45, "Homing timeout!");
            u8g2.sendBuffer();
            
            for (int i = 0; i < 5; i++) {
                setRGB(255, 0, 0);
                beep(1000, 200);
                delay(200);
                setRGB(0, 0, 0);
                delay(200);
            }
            
            while(1);
        }
        
        ledState = !ledState;
        setRGB(ledState ? 255 : 0, 0, 0);
        delay(100);
    }
    
    Serial.println("âœ… æ­¸é›¶å®Œæˆï¼");
    beep(1500, 200);
    setRGB(0, 255, 0);
    
    u8g2.clearBuffer();
    u8g2.setFont(u8g2_font_ncenB08_tr);
    u8g2.drawStr(0, 30, "System Ready!");
    u8g2.setFont(u8g2_font_6x10_tr);
    u8g2.drawStr(0, 50, "Press IR to switch");
    u8g2.sendBuffer();
    
    delay(2000);
    systemReady = true;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âš™ï¸ Setup
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

void setup() {
    Serial.begin(115200);
    Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    Serial.println("â•‘   æ™ºæ…§è¼”åŠ©è¼ªç³»çµ± v1.2 (äº¤ä»¶ç©©å®šç‰ˆ)    â•‘");
    Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
    
    Wire.begin();
    
    u8g2.begin();
    u8g2.clearBuffer();
    u8g2.setFont(u8g2_font_ncenB08_tr);
    u8g2.drawStr(0, 30, "Initializing...");
    u8g2.sendBuffer();
    delay(500);
    Serial.println("âœ“ OLED é¡¯ç¤ºå™¨å°±ç·’");
    
    IrReceiver.begin(IR_RECEIVE_PIN, ENABLE_LED_FEEDBACK);
    Serial.println("âœ“ IR æ¥æ”¶å™¨å°±ç·’");
    
    pinMode(RELAY_PIN, OUTPUT);
    pinMode(LIMIT_UP_PIN, INPUT_PULLUP);
    pinMode(LIMIT_DOWN_PIN, INPUT_PULLUP);
    pinMode(HALL_SPEED_PIN, INPUT_PULLUP);  // âœ… é‡è¦ï¼
    pinMode(RGB_RED_PIN, OUTPUT);
    pinMode(RGB_GREEN_PIN, OUTPUT);
    pinMode(RGB_BLUE_PIN, OUTPUT);
    pinMode(BUZZER_PIN, OUTPUT);
    Serial.println("âœ“ GPIO è…³ä½è¨­å®šå®Œæˆ");
    
    digitalWrite(RELAY_PIN, LOW);
    motorOn = false;
    Serial.println("âœ“ é¦¬é”å·²é—œé–‰");
    
    attachInterrupt(digitalPinToInterrupt(HALL_SPEED_PIN), speedInterrupt, FALLING);
    Serial.println("âœ“ éœçˆ¾æ„Ÿæ¸¬å™¨ä¸­æ–·å•Ÿå‹•");
    
    beep(1000, 100);
    delay(100);
    beep(1500, 100);
    delay(500);
    
    autoHoming();
    
    Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    Serial.println("â•‘          ç³»çµ±å°±ç·’ï¼é–‹å§‹é‹ä½œ            â•‘");
    Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”„ Loop
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

void loop() {
    currentSpeed = calculateSpeed();
    
    Command manual = checkManual();
    Command speed = checkSpeed();
    
    if (manual.priority < speed.priority) {
        activeCommand = manual;
    } else {
        activeCommand = speed;
    }
    
    executeCommand(activeCommand);
    
    updateDisplay();
    
    delay(50);
}
```

---

# ğŸ“Š v1.2 ä¿®æ­£å°ç…§è¡¨

| é …ç›® | v1.1ï¼ˆéŒ¯èª¤ç‰ˆï¼‰ | v1.2ï¼ˆä¿®æ­£ç‰ˆï¼‰ | èªªæ˜ |
|-----|--------------|--------------|------|
| **é€Ÿåº¦å…¬å¼** | `* 3.6` âŒ | `* 3600.0` âœ… | æ­£ç¢ºçš„å–®ä½è½‰æ› |
| **é™ä½ä¿è­·** | `stopMotor() + return` âŒ | åªæœ‰ `return` âœ… | é¿å…èª¤è§¸ç™¼ä¸‹é™ |
| **é–’ç½®è™•ç†** | `stopMotor() + return` âŒ | åªæœ‰ `return` âœ… | ä¸æœƒä¸€ç›´ä¸‹é™ |

---

# ğŸ¯ ç‚ºä»€éº¼ v1.2 æ˜¯æ­£ç¢ºçš„ï¼Ÿ

## å•é¡Œ 1ï¼šé€Ÿåº¦å…¬å¼ç‚ºä»€éº¼æ˜¯ *3600 è€Œä¸æ˜¯ *3.6ï¼Ÿ

**å–®ä½è½‰æ›è¨ˆç®—ï¼š**
```
å‘¨é•·ï¼š2042 mm
æ™‚é–“é–“éš”ï¼šspeedInterval (Î¼s)

é€Ÿåº¦ = å‘¨é•· / æ™‚é–“
     = 2042 mm / speedInterval Î¼s
     = (2042 / speedInterval) mm/Î¼s

è¦è½‰æˆ km/hï¼š
1 km = 1,000,000 mm
1 h  = 3,600,000,000 Î¼s

æ‰€ä»¥ï¼š
mm/Î¼s â†’ km/h è¦ä¹˜ä»¥ï¼š3,600,000,000 / 1,000,000 = 3600

æ­£ç¢ºå…¬å¼ï¼š
é€Ÿåº¦ (km/h) = (2042 / speedInterval) * 3600
```

**ç¯„ä¾‹è¨ˆç®—ï¼š**
```
å‡è¨­è¼ªå­ 1 ç§’è½‰ä¸€åœˆï¼š
- speedInterval = 1,000,000 Î¼s
- é€Ÿåº¦ = (2042 / 1,000,000) * 3600
       = 0.002042 * 3600
       = 7.35 km/h âœ… åˆç†

å¦‚æœç”¨ *3.6ï¼ˆéŒ¯èª¤ï¼‰ï¼š
- é€Ÿåº¦ = (2042 / 1,000,000) * 3.6
       = 0.002042 * 3.6
       = 0.00735 km/h âŒ å¹¾ä¹æ˜¯ 0
```

---

## å•é¡Œ 2ï¼šç‚ºä»€éº¼é™ä½æ™‚ä¸èƒ½å‘¼å« stopMotor()ï¼Ÿ

**ä½ çš„ç¡¬é«”æ©Ÿæ§‹ï¼š**
```
ç¹¼é›»å™¨ ON  = è‡´å‹•å™¨ä¼¸å‡º = ä¸Šå‡
ç¹¼é›»å™¨ OFF = è‡´å‹•å™¨æ”¶å› = ä¸‹é™

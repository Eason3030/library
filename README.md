# 自行車輔助輪控制系統

## 專案概述
本專案為一套自行車輔助輪控制系統，整合紅外線遙控、霍爾感測器、速度感測與 MPU6050 陀螺儀，並搭配 OLED 顯示、RGB LED 狀態提示及音效反饋，以提升自行車行駛安全性與互動體驗。

---

## 系統功能

### 1. 輔助輪控制
- **手動模式**
  - **紅外線遙控**：按下遙控器切換 UP/DOWN 狀態。
  - **霍爾感測器**：感測按壓自動控制輔助輪。
  - **RGB LED 指示**：DOWN 顯示黃色，UP 顯示綠色。
  - **音效提示**：放下或收起輔助輪時播放不同音階。
- **自動模式**
  - 速度低於 10 km/h 時自動放下輔助輪。
  - 速度高於 10 km/h 時自動收起輔助輪。
  - 對應 RGB LED：低速黃色，高速綠色。
- **傾斜警告**
  - 當傾斜角度超過 20° 且持續 0.5 秒，自動放下輔助輪，RGB LED 顯示藍色。
  - 當角度低於 12° 並持續 3 秒，自動收起輔助輪，RGB LED 變回綠色。
  - 發出音效提示。
- **緊急停止**
  - 當角度超過 35°，立即鎖定輔助輪 DOWN，RGB LED 顯示紅色並播放警告音。
  - 當角度低於 12°，解除緊急狀態。

---

### 2. 感測與控制模組
- **MPU6050**：讀取加速度與陀螺儀數據，計算傾斜角度。
- **霍爾感測器**：檢測手動操作。
- **速度感測**：透過霍爾輪速計算即時速度。
- **紅外線接收器**：接收遙控指令切換輔助輪狀態。

---

### 3. 顯示與互動
- **OLED 顯示器**：
  - 顯示系統狀態、輔助輪 UP/DOWN、即時速度及傾斜角度。
  - 提供啟動畫面與測試動畫。
- **RGB LED**：
  - 透過不同顏色顯示系統狀態（紅、藍、黃、綠、紫、關閉）。
- **音效提示**：
  - 系統啟動、輔助輪切換、緊急警告及完成操作皆有音效反饋。

---

### 4. 測試功能
- OLED 顯示、紅外線、MPU6050、霍爾感測器、速度感測器模組測試。
- RGB LED 與音效確認。
- 每個模組測試結果會在 OLED 顯示及音效反饋中呈現。

---

### 5. 開發進度
- 系統整合：紅外線、霍爾、速度、MPU6050
- OLED 顯示與動畫完成
- RGB LED 顏色對應邏輯完成
- 音效功能完成
- 模組測試功能完成
- 非阻塞優化（延遲替換，提升反應速度）

---
🚦 RGB LED 狀態指示
顏色狀態說明
🟢 綠色正常運行速度 ≥ 10 km/h，輔助輪 UP
🟡 黃色輔助輪 DOWN速度 < 10 km/h 或手動下降
🔵 藍色傾斜警告角度 > 20°，輔助輪自動下降
🔴 紅色緊急狀態角度 > 35° 或過載保護
🟣 紫色(保留)未使用


### 6. 未來優化方向
- 將 `beep()` 和動畫延遲改為非阻塞方式，提高緊急狀態與傾斜反應即時性。
- 加入數據紀錄功能，可將速度與傾斜角度存檔。
- 優化 OLED 顯示界面，使動畫與資訊更流暢。
```mermaid
graph TD
    A[系統啟動] --> B[硬體初始化]
    B --> B1[OLED 顯示器]
    B --> B2[MPU6050 陀螺儀]
    B --> B3[INA226 電流監測]
    B --> B4[霍爾感測器 x3]
    B --> B5[IR 紅外線接收器]
    B1 & B2 & B3 & B4 & B5 --> C[RGB 測試與啟動動畫]
    C --> D[進入主迴圈 Loop]
    
    D --> E[讀取所有感測器]
    E --> E1[MPU6050 傾斜角度]
    E --> E2[INA226 電流值]
    E --> E3[速度霍爾脈衝]
    E --> E4[端點霍爾狀態]
    E --> E5[緊急按鈕狀態]
    E --> E6[IR 遙控訊號]
    
    E1 & E2 & E3 & E4 & E5 & E6 --> F[三層決策邏輯]
    
    F --> G1[🔴 第一層：安全層]
    G1 --> G1A{過載 或 緊急按鈕?}
    G1A -->|是| G1B[HALTED - 輔助輪強制下降]
    G1B --> G1C[等待 5 秒冷卻]
    G1C --> G1D[返回 RUNNING]
    G1A -->|否| G2
    
    G2[🔴 緊急傾斜層] --> G2A{角度 > 35°?}
    G2A -->|是| G2B[緊急下降輔助輪]
    G2B --> G2C[RGB 紅色閃爍 + 警報聲]
    G2A -->|否| G3
    
    G3[🔵 傾斜警告層] --> G3A{角度 > 20° 持續 0.5s?}
    G3A -->|是| G3B[輔助輪下降]
    G3B --> G3C[RGB 藍色 + 警告音]
    G3C --> G3D{角度 < 12° 持續 3s?}
    G3D -->|是| G3E[自動收起輔助輪]
    G3D -->|否| G3C
    G3A -->|否| G4
    
    G4[🟢 操作層] --> G4A{霍爾端點鎖定?}
    G4A -->|是| G4B[保持鎖定位置]
    G4B --> G4C[RGB 黃色/綠色]
    G4A -->|否| G4D{手動模式 IR?}
    G4D -->|是| G4E[手動控制 UP/DOWN]
    G4E --> G4F[RGB 黃色/綠色]
    G4D -->|否| G4G[⭐ 自動速度控制]
    
    G4G --> G4H{速度 < 10 km/h?}
    G4H -->|是| G4I[輔助輪 DOWN]
    G4I --> G4J[繼電器 ON + RGB 黃色]
    G4H -->|否| G4K[輔助輪 UP]
    G4K --> G4L[繼電器 OFF + RGB 綠色]
    
    G1D & G2C & G3E & G4C & G4F & G4J & G4L --> H[輸出控制訊號]
    H --> H1[繼電器控制]
    H --> H2[PWM 週期控制]
    H --> H3[RGB LED 顯示]
    H --> H4[OLED 畫面更新]
    H --> H5[序列埠除錯輸出]
    
    H1 & H2 & H3 & H4 & H5 --> D
